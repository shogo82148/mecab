name: mecab on MinGW

on:
  pull_request:
    paths:
      - ".github/workflows/test-mingw.yml"
      - "mecab/**"
  push:
    branches:
      - main
    paths:
      - ".github/workflows/test-mingw.yml"
      - "mecab/**"

jobs:
  test:
    name: Test
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v2
      - name: Set ENV
        run: |
          # MSYS2 is pre-installed from https://github.com/actions/virtual-environments/releases/tag/win19%2F20200608.1
          # but not added to PATH.
          # so, we need to add it to PATH here.
          echo 'C:\msys64;' >> "$GITHUB_PATH"
          echo 'C:\msys64\bin' >> "$GITHUB_PATH"
          echo 'C:\msys64\usr\bin' >> "$GITHUB_PATH"
          echo 'C:\msys64\mingw64\bin' >> "$GITHUB_PATH"
        shell: bash
      - name: setup MSYS2
        run: |
          msys2_shell.cmd -c "pacman-key --init"
          msys2_shell.cmd -c "pacman-key --populate msys2"
          msys2_shell.cmd -c "pacman.exe -Sy"
          msys2_shell.cmd -c "pacman.exe -S --verbose --noconfirm --noprogressbar --needed autoconf bison make automake1.16 automake-wrapper mingw-w64-x86_64-gcc mingw-w64-x86_64-libtool"
      - name: configure
        run: |
          msys2_shell.cmd -c "./autogen.sh"
          msys2_shell.cmd -c "./configure --host=x86_64-w64-mingw32"
        working-directory: mecab
      - name: make
        run: |
          msys2_shell.cmd -c "make all"
          msys2_shell.cmd -c "make check"
          msys2_shell.cmd -c "make install"
        working-directory: mecab

      - name: build ipadic
        run: |
          msys2_shell.cmd -c "./autogen.sh"
          msys2_shell.cmd -c "./configure --with-charset=utf8"
          msys2_shell.cmd -c "make all"
          msys2_shell.cmd -c "make install"
        working-directory: mecab-ipadic
